name: DeepChecks CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run automated monitoring daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-data:
    name: Data Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd deepchecks
        pip install -r requirements.txt
    
    - name: Run data integrity checks
      run: |
        cd deepchecks
        source venv/bin/activate || python -m venv venv && source venv/bin/activate
        pip install -r requirements.txt
        python example_tabular.py
    
    - name: Archive DeepChecks results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deepchecks-results
        path: |
          deepchecks/results/*.html
          deepchecks/monitoring_results/*.json
          deepchecks/monitoring_results/*.csv
        retention-days: 30
    
    - name: Check for critical alerts
      run: |
        cd deepchecks
        if [ -f monitoring_results/alerts.json ]; then
          CRITICAL_COUNT=$(python -c "import json; alerts=json.load(open('monitoring_results/alerts.json')); print(sum(1 for a in alerts if a['level']=='critical'))")
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "CRITICAL: $CRITICAL_COUNT critical alerts detected!"
            exit 1
          fi
        fi

  automated-monitoring:
    name: Automated Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd deepchecks
        pip install -r requirements.txt
    
    - name: Run automated monitoring
      run: |
        cd deepchecks
        source venv/bin/activate || python -m venv venv && source venv/bin/activate
        pip install -r requirements.txt
        python automated_monitoring.py --skip-model-eval
    
    - name: Upload monitoring reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: monitoring-reports
        path: |
          deepchecks/monitoring_results/*
          deepchecks/results/*.html
        retention-days: 90
    
    - name: Create monitoring summary
      run: |
        cd deepchecks
        if [ -f monitoring_results/monitoring_summary.txt ]; then
          cat monitoring_results/monitoring_summary.txt
        fi

  llm-data-validation:
    name: LLM Data Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd deepchecks
        pip install -r requirements.txt
    
    - name: Run LLM data validation
      run: |
        cd deepchecks
        source venv/bin/activate || python -m venv venv && source venv/bin/activate
        pip install -r requirements.txt
        python llm_data_validation.py
    
    - name: Archive LLM validation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: llm-validation-results
        path: deepchecks/results/rag_*.html
        retention-days: 30

